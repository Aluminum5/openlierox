#!/usr/bin/python -u
# Dedicated Control handler script for OpenLieroX
# (http://openlierox.sourceforge.net)
# Upon editing - keep good names and excessive comments
# Written for easy editing by newcomers to python or programming in general
# OH AND I MEAN THIS ABOUT EXCESSIVE COMMENTS T.T
# As usual, try to hardcode as little as possible, it becomes magical numbers for everyone except you(!!)

import os, sys, time # Useful imports
sys.path.append(os.getcwd()+"/cfg") # Append cfg dir to Python imports search paths
sys.path.append(os.getcwd()+"/scripts") # Append current dir to Python imports search paths

import dedicated_config  # Per-host config like admin password 
import dedicated_control_functions # Low-level stuff
cfg = dedicated_config # shortcut
ded = dedicated_control_functions # shortcut

## Global vars ##

## The game loop ##

ded.msg("GameState = %s" % str(ded.gameState))

ded.startLobby(cfg.LOCAL_BOT_NAME)

ded.initPresets()

ded.waitLobbyStarted()

ded.setvar("GameServer.ServerName", cfg.SERVER_NAME)

ded.setvar("GameServer.GameInfo.sWelcomeMessage", cfg.WELCOME_MESSAGE)
ded.setvar("GameServer.MaxPlayers", cfg.MAX_PLAYERS)

ded.setvar("GameServer.GameInfo.iGameMode", "0") # 0 - DM, 1 - Team DM
ded.setvar("GameServer.GameInfo.iLives", cfg.GAME_LIVES)
ded.setvar("GameServer.GameInfo.iKillLimit", cfg.GAME_MAX_KILLS)
ded.setvar("GameServer.GameInfo.fTimeLimit", cfg.GAME_MAX_TIME)
ded.setvar("GameOptions.Advanced.WeaponSelectionMaxTime", cfg.WEAPON_SELECTION_TIME)

ded.selectNextPreset()

while ded.gameState != ded.GAME_QUIT:
    if ded.startWithMinWorms( cfg.MIN_PLAYERS, cfg.KILL_LOCAL_BOT, cfg.WAIT_BEFORE_GAME, cfg.WAIT_BEFORE_GAME*10,
                          cfg.TOO_FEW_PLAYERS_MESSAGE, cfg.WAIT_BEFORE_GAME_MESSAGE ):
        ded.WaitInLobby(cfg.WAIT_AFTER_GAME) # Game was played, wait a bit

    ded.selectNextPreset() # Game was not played

    if len(ded.worms) >= cfg.MIN_PLAYERS_TEAMS: # Split in teams
        ded.setvar("GameServer.GameInfo.iGameMode", "1")
        ded.sendLobbyUpdate() # Update game mode info
        for w in ded.worms.keys():
            ded.setWormTeam( w, w % 2 )
    else:
        ded.setvar("GameServer.GameInfo.iGameMode", "0")
        ded.sendLobbyUpdate() # Update game mode info


sys.exit() # Kill the stdin-input thread
