#!/bin/bash


function startlobby() {
	echo "startlobby"
}

function startgame() {
	echo "startgame"
}

function msg() {
	echo "msg $1"
}

function chatmsg() {
	echo "chatmsg $1"
}

function start_with_countdown() {
	c=20
	while [ "$c" -ge 1 ]; do
		[ "$c" -ge 10 ] && d=2 || d=1
		msg "$c ..."
		chatmsg "$c ..."
		sleep $d
		c=$(expr "$c" - $d)
	done

	startgame
}

function wait_for_gameloopend() {
	local signal
	while read signal; do
		msg "gameloop: $signal"
		[ "$signal" == "gameloopend" ] && {
			sleep 1
			chatmsg "back in lobby, waiting ..."
			return
		}
		[ "$signal" == "quit" ] && exit
	done
}

function signal_handler() {
	local signal
	while read signal; do
		msg "lobby: $signal"
		[ "$signal" == "quit" ] && exit
		[ "$signal" == "gameloopstart" ] && wait_for_gameloopend && return
	done
}

echo "getcomputerwormlist"

startlobby

while true; do
	start_with_countdown
	signal_handler
done

